<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo List</title>

    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-5.3.7/package/dist/css/bootstrap.min.css"
    />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-icons-1.13.1/package/font/bootstrap-icons.min.css"
    />

    <link rel="stylesheet" href="/style/custom.css" />
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="card shadow-lg border-0 rounded-4">
        <div
          class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center rounded-top-4"
        >
          <div class="d-flex align-items-center">
            <i class="bi bi-check2-square display-6 me-3"></i>
            <div>
              <h3 class="mb-0">Todo List</h3>
              <small class="text-white-50"
                >Atur rencanamu dengan rapi disini</small
              >
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button
              id="clearCompleted"
              class="btn btn-sm btn-light"
              title="Hapus semua yang selesai"
            >
              <i class="bi bi-trash-fill text-danger"></i> Hapus Selesai
            </button>
            <button
              id="clearAll"
              class="btn btn-sm btn-outline-light"
              title="Hapus semua todo"
            >
              <i class="bi bi-x-circle"></i> Reset
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Form tambah -->
          <form id="formData" class="mb-4">
            <label for="text" class="form-label fw-semibold">
              Apa rencanamu Selanjutnya?
            </label>
            <div class="input-group input-group-lg">
              <span class="input-group-text"
                ><i class="bi bi-list-task"></i
              ></span>
              <input
                id="todoInput"
                type="text"
                class="form-control"
                name="todo"
                placeholder="Tulis todo baru..."
                aria-label="Tulis todo baru"
                autocomplete="off"
              />
              <button type="submit" class="btn btn-primary" title="Tambah todo">
                <i class="bi bi-plus-lg"></i> Tambah
              </button>
            </div>
            <div id="formHelp" class="form-text">
              Tidak boleh kosong & tidak boleh duplikat.
              <p>Masa Rencana Kegiatan Kosong? atau duplikat</p>
            </div>
          </form>

          <!-- Filter dan Pencarian -->
          <div class="row g-2 mb-4 align-items-center">
            <div class="col-md-4">
              <select id="filter" class="form-select" aria-label="Filter todo">
                <option value="all">Semua</option>
                <option value="completed">Selesai</option>
                <option value="pending">Belum Selesai</option>
              </select>
            </div>
            <div class="col-md-8">
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="bi bi-search"></i
                ></span>
                <input
                  type="text"
                  id="search"
                  class="form-control"
                  placeholder="Cari todo..."
                  aria-label="Cari todo"
                />
                <button
                  id="clearSearch"
                  class="btn btn-outline-secondary"
                  title="Bersihkan pencarian"
                >
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Todo List -->
          <ul class="list-group" id="todoList" aria-live="polite"></ul>
        </div>
      </div>
    </div>

    <!-- Edit Modal (Bootstrap) -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="editForm">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">
                <i class="bi bi-pencil-square me-2"></i>Edit Todo
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editTodoInput" class="form-label">Judul</label>
                <input
                  type="text"
                  id="editTodoInput"
                  class="form-control"
                  required
                />
                <div id="editHelp" class="form-text">
                  Judul tidak boleh sama dengan todo lain.
                </div>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="editCompleted"
                />
                <label class="form-check-label" for="editCompleted"
                  >Tandai selesai</label
                >
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Batal
              </button>
              <button type="submit" class="btn btn-primary">
                Simpan Perubahan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (lokal) -->
    <script src="/assets/vendor/bootstrap-5.3.7/package/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Key di localStorage
      const STORAGE_KEY = "todos_v1";

      // state
      let todos = [];
      let filterStatus = "all";
      let searchQuery = "";

      // helper: generate id (timestamp + random)
      const generateId = () =>
        Date.now().toString(36) + Math.random().toString(36).slice(2, 7);

      // load
      function loadTodos() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          try {
            todos = JSON.parse(data);
          } catch {
            todos = [];
          }
        }
      }

      function saveTodos() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
      }

      // rendering
      function renderTodos() {
        const list = document.getElementById("todoList");
        list.innerHTML = "";

        const filtered = todos.filter((t) => {
          if (filterStatus === "completed" && !t.completed) return false;
          if (filterStatus === "pending" && t.completed) return false;
          if (searchQuery && !t.todo.toLowerCase().includes(searchQuery))
            return false;
          return true;
        });

        if (filtered.length === 0) {
          const empty = document.createElement("li");
          empty.className = "list-group-item text-center text-muted";
          empty.textContent = "Tidak ada todo yang sesuai.";
          list.appendChild(empty);
          return;
        }

        filtered.forEach((item, index) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex align-items-center justify-content-between shadow-sm mb-2 rounded draggable";
          li.setAttribute("draggable", "true");
          li.dataset.id = item.id;

          // left content
          const left = document.createElement("div");
          left.className = "d-flex align-items-center flex-fill gap-3";

          const dragHandle = document.createElement("i");
          dragHandle.className = "bi bi-grip-vertical drag-handle";
          dragHandle.title = "Seret untuk mengurutkan";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "form-check-input";
          checkbox.checked = item.completed;
          checkbox.addEventListener("change", () => {
            // update by id
            const found = todos.find((t) => t.id === item.id);
            if (found) {
              found.completed = checkbox.checked;
              saveTodos();
              renderTodos();
            }
          });

          const textDiv = document.createElement("div");
          textDiv.className = "d-flex flex-column";
          const label = document.createElement("span");
          label.className = "fw-medium todo-text";
          label.style.textDecoration = item.completed ? "line-through" : "none";
          label.textContent = item.todo;

          const meta = document.createElement("small");
          meta.className = "text-muted";
          // meta.textContent = item.updatedAt ? "Diubah: " + new Date(item.updatedAt).toLocaleString() : "";

          textDiv.appendChild(label);
          textDiv.appendChild(meta);

          left.appendChild(dragHandle);
          left.appendChild(checkbox);
          left.appendChild(textDiv);

          // right actions
          const actions = document.createElement("div");
          actions.className = "d-flex align-items-center gap-2";

          const badge = document.createElement("span");
          badge.className = item.completed
            ? "badge bg-success"
            : "badge bg-warning text-dark";
          badge.textContent = item.completed ? "Selesai" : "Belum Selesai";

          const editBtn = document.createElement("button");
          editBtn.className = "btn btn-sm btn-outline-secondary";
          editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
          editBtn.title = "Edit";
          editBtn.addEventListener("click", () => openEditModal(item.id));

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-sm btn-outline-danger";
          deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
          deleteBtn.title = "Hapus";
          deleteBtn.addEventListener("click", () => {
            if (confirm("Hapus todo ini?")) {
              todos = todos.filter((t) => t.id !== item.id);
              saveTodos();
              renderTodos();
            }
          });

          actions.appendChild(badge);
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          li.appendChild(left);
          li.appendChild(actions);
          list.appendChild(li);

          // Drag events
          li.addEventListener("dragstart", (e) => {
            li.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", item.id);
          });

          li.addEventListener("dragend", () => {
            li.classList.remove("dragging");
          });
        });

        enableDragAndDrop();
      }

      // Drag & Drop: gunakan drop pada list, rebuild order dari DOM
      function enableDragAndDrop() {
        const list = document.getElementById("todoList");

        list.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = list.querySelector(".dragging");
          if (!dragging) return;

          // cari elemen target (bukan dragging)
          const afterElement = getDragAfterElement(list, e.clientY);
          if (!afterElement) {
            list.appendChild(dragging);
          } else {
            list.insertBefore(dragging, afterElement);
          }
        });

        list.addEventListener("drop", (e) => {
          e.preventDefault();
          // rebuild todos order berdasarkan DOM (semua li saat ini)
          const ids = Array.from(list.querySelectorAll("li"))
            .filter((li) => li.dataset.id)
            .map((li) => li.dataset.id);

          // buat urutan baru: jaga hanya todo yang ada di current storage (filtering mungkin hide some items)
          const newOrder = [];
          ids.forEach((id) => {
            const found = todos.find((t) => t.id === id);
            if (found) newOrder.push(found);
          });

          // jika ada todos yang tidak muncul karena filter/pencarian, tambahkan sisanya di akhir mempertahankan relative order sebelumnya
          todos.forEach((t) => {
            if (!newOrder.includes(t)) newOrder.push(t);
          });

          todos = newOrder;
          saveTodos();
          renderTodos();
        });
      }

      // helper: cari element setelah posisi kursor
      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll(".list-group-item:not(.dragging)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // Add todo
      document.addEventListener("DOMContentLoaded", () => {
        loadTodos();

        const form = document.getElementById("formData");
        const filterEl = document.getElementById("filter");
        const searchEl = document.getElementById("search");
        const clearSearch = document.getElementById("clearSearch");
        const clearCompletedBtn = document.getElementById("clearCompleted");
        const clearAllBtn = document.getElementById("clearAll");

        // initial render
        renderTodos();

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const input = document.getElementById("todoInput");
          const raw = input.value || "";
          const todoText = raw.trim();

          if (!todoText) {
            alert("Todo tidak boleh kosong!");
            return;
          }

          // validasi duplikat case-insensitive
          const exists = todos.some(
            (t) => t.todo.toLowerCase() === todoText.toLowerCase()
          );
          if (exists) {
            alert("Todo dengan judul sama sudah ada!");
            return;
          }

          const newTodo = {
            id: generateId(),
            todo: todoText,
            completed: false,
            createdAt: Date.now(),
            updatedAt: null,
          };

          // tambahkan di depan (newest first)
          todos.unshift(newTodo);
          input.value = "";
          saveTodos();
          renderTodos();
        });

        filterEl.addEventListener("change", () => {
          filterStatus = filterEl.value;
          renderTodos();
        });

        searchEl.addEventListener("input", () => {
          searchQuery = searchEl.value.trim().toLowerCase();
          renderTodos();
        });

        clearSearch.addEventListener("click", () => {
          searchEl.value = "";
          searchQuery = "";
          renderTodos();
        });

        clearCompletedBtn.addEventListener("click", () => {
          if (confirm("Yakin ingin menghapus semua todo yang selesai?")) {
            todos = todos.filter((t) => !t.completed);
            saveTodos();
            renderTodos();
          }
        });

        clearAllBtn.addEventListener("click", () => {
          if (confirm("Reset semua todo?")) {
            todos = [];
            saveTodos();
            renderTodos();
          }
        });
      });

      // EDIT modal logic
      const editModalEl = document.getElementById("editModal");
      const bootstrapModal = new bootstrap.Modal(editModalEl);
      let editingId = null;

      function openEditModal(id) {
        editingId = id;
        const todo = todos.find((t) => t.id === id);
        if (!todo) return;
        document.getElementById("editTodoInput").value = todo.todo;
        document.getElementById("editCompleted").checked = todo.completed;
        bootstrapModal.show();
      }

      document.getElementById("editForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const newTextRaw = document.getElementById("editTodoInput").value;
        const newText = (newTextRaw || "").trim();
        const newCompleted = document.getElementById("editCompleted").checked;

        if (!newText) {
          alert("Judul tidak boleh kosong!");
          return;
        }

        // cek duplikat kecuali dirinya sendiri
        const duplicate = todos.some(
          (t) =>
            t.todo.toLowerCase() === newText.toLowerCase() && t.id !== editingId
        );
        if (duplicate) {
          alert("Todo dengan judul sama sudah ada!");
          return;
        }

        const found = todos.find((t) => t.id === editingId);
        if (found) {
          found.todo = newText;
          found.completed = newCompleted;
          found.updatedAt = Date.now();
          saveTodos();
          renderTodos();
        }
        bootstrapModal.hide();
      });
    </script>
  </body>
</html>
